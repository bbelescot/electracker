<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ElecTracker : sondages et résultats des élections régionales 2021</title>
</head>
<body>

<nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid" style="max-width:1200px">
      <a class="navbar-brand" href="#">ElecTracker</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      Régions
                    </a>
                    <div id="dropdown-menu" class="dropdown-menu" aria-labelledby="navbarDropdown">
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#about">À propos</a>
              </li>
                <li class="nav-item">
                <a class="nav-link" href="https://github.com/rozierguillaume/electracker">Code source</a>
              </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container" style="padding-top: 30px;">
    <br>
    <h2>ElecTracker, agrégateur de sondages électoraux</h2><br>
    <p>Quels sont les sondages des élections régionales dans chaque région ? Quels sont les résultats des régionales 2021 ? Quels sont les candidats aux élections régionales ? ElecTracker est une plateforme citoyenne qui agrège les sondages des élections régionales en France.</p><br>

    <h2>Sondages des élections régionales 2021</h2>
    <div id="charts-regions"></div>

    <h2 id="about">À propos</h2>
    ElecTracker agrège les sondages des élections régionales en France. <a href="https://github.com/nsppolls/nsppolls">Source des données : NSPPolls</a>.
    <br><br>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
<script>

    var requestURL = 'https://raw.githubusercontent.com/rozierguillaume/electracker/main/data/output/regionales_metadata.json';
    var request = new XMLHttpRequest();
    request.open('GET', requestURL);
    request.responseType = 'json';
    request.send();
    request.onload = function() {
      var metadata = request.response;
      update_dropdown(metadata);
      metadata["regions"].map((region) => download_data_and_build_chart(region, metadata));
    }

    function download_data_and_build_chart(region, metadata) {
        update_html(region, metadata);
        var requestURL = `https://raw.githubusercontent.com/rozierguillaume/electracker/main/data/output/regionales_${region}.json`;
        var request = new XMLHttpRequest();
        request.open('GET', requestURL);
        request.responseType = 'json';
        request.send();
        request.onload = function () {
            var data = request.response;
            build_chart(data["data"], region);
            update_intro(data, region);
        }
    }

    function update_dropdown(metadata){
        metadata["regions"].map((region) => {
            region_name = metadata["regions_noms"][region]
            document.getElementById("dropdown-menu").innerHTML += `<a class="dropdown-item" href="#${region}">${region_name}</a>`
        })
    }
    function compare(a, b) {
      if (a.x<b.x)
         return -1;
      if (a.x>b.x)
         return 1;
      return 0;
}
    function build_chart_dataset(data){
        var datasets = [];
        for (var candidat in data) {
            var data_dataset = data[candidat]["dates"].map((value, idx) => ({x: value, y: data[candidat]["intentions"][idx]}))
            data_dataset.sort(compare)
            let dataset = {
                label: candidat + " (" + data[candidat]["parti"] + ")",
                data: data_dataset,
                borderColor: data[candidat]["couleur"],
                borderWidth: 4
            }
            datasets.push(dataset)
        }
        return datasets
    }

    function update_html(region, metadata){
        document.getElementById("charts-regions").innerHTML += `
            <h3 style="padding-top: 45px;" id="${region}">{region}</h3><br>
            <div id="${region}-intro"></div>
            <canvas id="chart-${region}" width="400" height="200"></canvas>
            <br><br>
            `.replace("{region}", metadata["regions_noms"][region])
    }

    function update_intro(data, region){
        string_to_display = "Sondages du premier tour :<br>";

        for (let i = 0; i < 4; i++) {
            candidat = data["candidats_ordonnes"][i];
            string_to_display += `• <b>${data["intentions_ordonnees"][i]} %</b> `
            string_to_display += `${candidat}`
            string_to_display += ` (${data["data"][candidat]["parti"]})<br>`
        }

        document.getElementById(`${region}-intro`).innerHTML += `${string_to_display}<br><br>`
    }


    function build_chart(data, region) {
        let chart_dataset = build_chart_dataset(data)
        let ctx = document.getElementById(`chart-${region}`).getContext('2d');
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: chart_dataset
            },
            options: {
                scales: {

                    y: {
                        beginAtZero: true
                    },
                    x: {
                        type: 'time',
                        //distribution: 'linear',
                    },
                }
            }
        });
    }

</script>
</body>
</html>